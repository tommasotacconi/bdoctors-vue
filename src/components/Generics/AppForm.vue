<script>
	import axios from 'axios';
	import { store } from '../../../js/store';
	import Multiselect from './Multiselect.vue';

	export default {
		data() {
			return {
				formData: {},
				errors: {},
				validated: undefined,
				sent: undefined,
				/* elements: {
						name: {
							id: '',
							type: ''
							placeholder: '',
						}
					 } */
				store,

			}
		},
		methods: {
			updateSpecs(specializations, reactiveObj, key) {
				// Prepare a constant array result to insert ids value
				const result = [];
				// Insert ids taken from specializations parameter in reactive variable specializations, property of errors 
				for (let i = 0; i < specializations.length; i++) {
					result.push(specializations[i].id);
				}

				reactiveObj[key] = result;
			},
			createFormData() {
				for (const key in this.elements) {
					if (key === 'specializationsId') this.$data.formData[key] = [];
					else if ((key === 'vote')) this.$data.formData[key] = null;
					else this.$data.formData[key] = '';
					this.$data.errors[key] = '';
				}
			},
			validateEmail(email) {
				const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;

				return re.test(email)
			},
			validateForm() {
				this.resetErrors();
				// Set errors if any
				for (const data in this.formData) {
					const value = this.formData[data];
					const label = this.elements[data].label;

					if (!value || value instanceof Array && !value.length) {
						if (data === 'content') {
							const msgAdaptedPart = label === 'Messaggio' ? '' : 'la';
							this.errors[data] = `Inserisci il corpo del${msgAdaptedPart} ${label.toLowerCase()}`;
						}
						else if (data === 'vote') this.errors[data] = 'Inserisci un voto in stetoscopi da 1 a 5';
						else if (data !== 'email' && data !== 'password' && data !== 'pwConf') this.errors[data] = `Il ${label.toLowerCase()} è obbligatorio`;
						else this.errors[data] = `La ${label.toLowerCase()} è obbligatoria`;
					}
					else if ((data === 'first_name' || data === 'last_name') && value.length <= 2)
						this.errors[data] = `Il ${label.toLowerCase()} deve contenere almeno 3 caratteri`;
					else if (data === 'email' && !this.validateEmail(value)) this.errors[data] = 'L\'email inserita non è valida';
				}
				// Run custom validation function if any
				if (this.perfectValidation) this.perfectValidation(this);
				// Check form validity by errors' presence
				let isValid = true;
				for (const data of Object.keys(this.formData)) {
					if (this.errors[data]) isValid = false;
				}
				if (isValid) {
					this.validated = true;
					this.sendForm();
				}

				// console.table({ 'Form\'s data': this.formData });
				// console.table({ 'Form\'s errors': this.errors });
			},
			resetForm() {
				for (const key in this.formData) {
					if (key !== 'vote') this.formData[key] = '';
					else this.formData[key] = null;
					this.validated = false;
				}
			},
			resetErrors() {
				for (const key in this.formData) {
					this.errors[key] = '';
				}
			},
			sendForm() {
				this.sent = null;
				// Convert to snake_case data
				const { pwConf, ...data } = this.camelToSnake(this.formData);
				// console.log(data);
				axios.post(this.store.apiUri + this.apiRoute, {
					doctor_details: this.doctorInfo,
					...data,
				})
					.then(response => {
						// console.log('message sent.', response.data);
						this.sent = true;
						this.resetForm();
					})
					.catch(err => {
						// console.log(err.response.data);
						this.sent = false;
					})
			},
			camelToSnake(obj) {
				const result = {};
				for (const [key, value] of Object.entries(this.formData)) {
					const snakeKey = key.replace(/[A-Z]/g, letter => `_${letter.toLowerCase()}`);
					result[snakeKey] = value;
				}

				return result;
			}
		},
		computed: {
			formContent() {
				if (this.elements.content) return this.elements.content.label;
				else if (this.elements.firstName && this.elements.lastName) return 'Registrazione';
			},
			formContentSuffix() {
				const cont = this.formContent;
				if (cont.search(/^(Messaggio|Recensione)$/) !== -1) return cont === 'Messaggio' ? 'o' : 'a';
				else return cont === 'Accesso' ? 'o' : 'a';
			},
			formContentArticle() {
				const cont = this.formContent;
				if (this.formContent.search(/^(Messaggio|Recensione)$/ !== -1)) return cont === 'Messaggio' ? 'il' : 'la';
				else return cont === 'Accesso' ? 'il' : 'la';
			},
			yourFormContentSentence() {
				if (this.formContent && this.formContentSuffix && this.formContentArticle) return `${this.formContentArticle[0].toUpperCase() + this.formContentArticle.slice(1)} tu${this.formContentSuffix} ${this.formContent.toLowerCase()}`;
			}
		},
		props: {
			apiRoute: {
				type: String,
				required: true
			},
			elements: {
				type: Object,
				required: true
			},
			doctorInfo: {
				type: [Object, null],
				required: true
			},
			perfectValidation: {
				type: Function,
				required: false
			},
			isRendered: {
				type: Boolean,
				required: false
			},
			formFrameClass: {
				type: Object
			},
			formClass: {
				type: Object
			},
			wrapperInnerDiv: {
				type: Object
			}
		},
		components: {
			Multiselect
		},
		created() {
			this.createFormData();
		},
	}
</script>

<template>
	<div class="form-frame p-3 pt-1" :class="formFrameClass">
		<form v-if="sent === undefined" id="message-form" @submit.prevent="validateForm" novalidate :class="formClass">
			<!-- Generic form element -->
			<div :class="wrapperInnerDiv">
				<!-- Form field's template -->
				<div class="mb-2" :class="el.wrapperStyle" v-for="(el, key) in elements">
					<!-- If vote field -->
					<template v-if="key === 'vote'">
						<label class="badge rounded-pill">{{ el.label }}</label>
						<div class="form-control text-center vote">
							<template v-for="vote in [5, 4, 3, 2, 1]">
								<input :id="el.id + vote" class="form-control" :class="{ 'invalid-input': errors[key] }" :value="vote"
									v-model.trim="formData[key]" :type="el.type" required>
								<label :for="el.id + vote" class="form-label stethoscope"><i
										class="fa-solid fa-stethoscope"></i></label>
							</template>
						</div>
					</template>
					<!-- If specializations' multiselect field -->
					<template v-else-if="key === 'specializationsId'">
						<label for="el.id" class="badge rounded-pill">{{ el.label }}</label>
						<Multiselect id="" class="specializations-multiselect" :class="{ 'invalid-input': errors[key] }"
							@send-values="(specializations) => { updateSpecs(specializations, formData, key); }" />
					</template>
					<!-- If other fields of type text input and textarea -->
					<template v-else>
						<label :for="el.id" class="badge rounded-pill">{{ el.label }}</label>
						<input v-if="key !== 'content'" :id="el.id" v-model.trim="formData[key]" :type="el.type"
							:placeholder="el.placeholder" class="form-control" :class="{ 'invalid-input': errors[key] }"
							:rows="key === 'content' ? 3 : null" required>
						<textarea v-if="key === 'content'" :id="el.id" v-model.trim="formData[key]" :placeholder="el.placeholder"
							class="form-control" :class="{ 'invalid-input': errors[key] }" :rows="key === 'content' ? 3 : null"
							required></textarea>
					</template>
					<!-- Box for single input's error message -->
					<div class="invalid" v-if="errors[key]">
						<p>{{ errors[key] }}</p>
					</div>
				</div>

				<!-- Submit button for review or message form-->
				<div v-if="formContent === 'Messaggio' || formContent === 'Recensione'" class="buttons-wrapper text-center">
					<button type="submit" class="btn btn-primary btn-submit mx-auto mt-4" :class="{ 'disabled': validated }">Invia
						{{ formContent.toLowerCase() }}
					</button>
				</div>
				<!-- Submit, reset buttons for registration or login -->
				<div v-if="formContent === 'Registrazione'" class="buttons-wrapper mt-3">
					<button type="submit" id="register-button" class="btn btn-primary btn-submit mx-auto"
						:class="{ 'disabled': validated }">Registrati
					</button>
					<button type="button" id="reset-button" class="btn btn-warning ms-3" :class="{ 'disabled': validated }"
						@click.prevent="resetForm()">Pulisci
					</button>
				</div>
			</div>
		</form>

		<Loader v-else-if="sent === null" />

		<!-- Notification message for successfull sending -->
		<div v-else-if="sent" class="my-3">
			<p class="my-2 px-2">
				{{ yourFormContentSentence }} è stat{{ formContentSuffix }} inviat{{ formContentSuffix }} correttamente.
			</p>
			<button type="button" @click="sent = undefined" class="btn btn-primary btn-sm">Invia nuov{{ formContentSuffix
			}}</button>
		</div>

		<!-- Notification message for impossible sending -->
		<div v-else class="my-3">
			<p class="my-2 px-2">
				{{ yourFormContentSentence }} non può essere inviat{{ formContentSuffix }} al momento. Controlla la
				connessione
				a
				internet
				o riprova più tardi.
			</p>
			<button type="button" @click="sent = undefined; validated = undefined"
				class="btn btn-primary btn-sm">Riprova</button>
		</div>
	</div>
</template>

<style scoped>
	.form-frame {
		min-height: 400px;
		display: flex;

		justify-content: center;
		align-items: center;
		border-radius: var(--bs-border-radius);
		/* border: var(--bs-border-width) solid var(--color-primary); */
		/* box-shadow: 0px 4px 20px -10px var(--color-tertiary); */

		/* Loader sizing */
		.loader {
			width: 34px;
			position: static;
			translate: none;
		}
	}

	.btn {
		span {
			margin-right: 5px;
			display: none;
		}
	}

	form {
		width: 100%;
		text-align: start;
		animation: 0.6s ease-out 0.6s forwards fade;
		opacity: 0;

		label.badge.rounded-pill {
			background-color: var(--color-tertiary);
		}

		input[type="text"].form-control,
		input[type="email"],
		textarea.form-control,
		div.form-control {
			border: 2px solid var(--color-tertiary);
		}

		input[type="text"].form-control,
		input[type="email"] {
			height: 3.2rem;
		}


		/* Form error */
		.invalid {
			color: var(--color-error);

			p {
				margin: 0;
			}
		}

		.invalid-input {
			border-color: red;
		}

		/*vote*/
		.vote {
			padding: 10px 0;
			margin-bottom: 20px;

			display: flex;
			flex-direction: row-reverse;
			justify-content: center;

			& input {
				display: none;
			}

			& label {
				height: 2.5rem;
				aspect-ratio: 1;
				margin: 0 2.5px;
				border: 2px solid var(--color-tertiary);
				border-radius: 50%;

				line-height: 2.5rem;
				font-size: 1.3rem;
				cursor: pointer;
				transition: color 1s ease-out;
			}

			& label:hover,
			& label:hover~label {
				background-color: var(--color-tertiary);
				color: var(--color-complementary);
			}

			& input:checked~label {
				background-color: var(--color-tertiary);
				color: var(--color-complementary);
			}
		}

	}
</style>